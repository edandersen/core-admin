@using System.Collections
@using DotNetEd.CoreAdmin
@using Microsoft.Extensions.Localization
@using NonFactors.Mvc.Grid
@using System.Linq.Expressions
@using Microsoft.EntityFrameworkCore;
@using System.ComponentModel.DataAnnotations;
@using System.Reflection
@inject IEnumerable<DotNetEd.CoreAdmin.CoreAdminOptions> CoreAdminOptions
@model DotNetEd.CoreAdmin.ViewModels.DataListViewModel
@inject IStringLocalizer<JsonLocalizer> _localizer

@{
    ViewData["Page_Title"] = Model.DbSetProperty.Name;
    Layout = "_CoreAdminLayout";

    var options = CoreAdminOptions.FirstOrDefault();
}

<h1 class="mt-3">@Model.DbSetProperty.Name</h1>

<div class="row">
    <div class="col-lg-12 my-3 text-end">
        @Html.ActionLink(_localizer["CreateNew"], "Create", new { id = Model.DbSetProperty.Name }, new { @class = "btn btn-primary"})
    </div>
</div>

@(Html
    .Grid(Model.Data)
    .Build((columns) => {

        foreach(var entityProperty in Model.EntityType.GetProperties())
        {

            ParameterExpression entity = Expression.Parameter(typeof(object), "ent");
            var changedType = Expression.Convert(entity, Model.EntityType);
            var property = Expression.Property(changedType, entityProperty.Name);
            var propertyDisplayName = entityProperty.Name;
            if(Attribute.IsDefined(entityProperty, typeof(DisplayAttribute)))
            {
                var displayAttribute = entityProperty.GetCustomAttributes(typeof(DisplayAttribute),true).FirstOrDefault() as DisplayAttribute;
                if(displayAttribute != null)
                {
                    var displayAutoGeneratedField = displayAttribute.GetAutoGenerateField();
                    if(!( displayAutoGeneratedField.HasValue? displayAutoGeneratedField.Value : false ))
                        continue;
                        if(!string.IsNullOrEmpty(displayAttribute.Description))
                    propertyDisplayName = displayAttribute.Description;
                }
            }         
            else if (entityProperty.PropertyType == typeof(Boolean))
            {
                var lambda = Expression.Lambda<Func<object, Boolean>>(property, entity);
                columns.Add(lambda).RenderedAs(m=> Html.CheckBox(entityProperty.Name, lambda.Compile().Invoke(m))).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(byte[]))
            {
                var lambda = Expression.Lambda<Func<object, byte[]>>(property, entity);

                columns.Add(lambda).Titled(entityProperty.Name)
                    .RenderedAs((value) => {
                        var base64 = ImageUtils.WebBase64EncodeImageByteArrayOrNull(lambda.Compile().Invoke(value));
                        return base64 == null ? string.Empty : $"<img height='48' src='{base64}'>";
                    } ).Encoded(false);
            }
            else if (entityProperty.PropertyType.IsAssignableTo(typeof(IEnumerable)) && entityProperty.PropertyType != typeof(string))
            {
                var lambda = Expression.Lambda<Func<object, object>>(property, entity);

                columns.Add(lambda).Titled(entityProperty.Name)
                    .RenderedAs((value) =>
                    {
                        var finalString = "<ul>";
                        try
                        {
                            foreach (var raw in (IEnumerable)entityProperty.GetValue(value)!)
                            {
                                finalString += $"<li><a href=\"{Url.Action("Index", new { id = raw.GetType().Name })}\">{raw}</a></li>";
                            }
                        }
                        catch(NullReferenceException) {}
                        finalString += "</ul>";
                        return finalString;
                    } ).Encoded(false);
            }
             /*  if (entityProperty.PropertyType == typeof(Guid))
            {
                var lambda = Expression.Lambda<Func<object,Guid>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(string))
            {
                var lambda = Expression.Lambda<Func<object,string>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(Int32))
            {
                var lambda = Expression.Lambda<Func<object,Int32>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(DateTime))
            {
                var lambda = Expression.Lambda<Func<object,DateTime>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(DateTimeOffset))
            {
                var lambda = Expression.Lambda<Func<object,DateTimeOffset>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(double))
            {
                var lambda = Expression.Lambda<Func<object, double>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if (entityProperty.PropertyType == typeof(decimal))
            {
                var lambda = Expression.Lambda<Func<object, decimal>>(property, entity);

                columns.Add(lambda).Titled(propertyDisplayName);
            }
              else if(entityProperty.PropertyType == typeof(decimal?)){
                var lambda = Expression.Lambda<Func<object, decimal?>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }
            else if(entityProperty.PropertyType == typeof(DateTime?)){
                var lambda = Expression.Lambda<Func<object, DateTime?>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }
             else if(entityProperty.PropertyType == typeof(int?)){
                var lambda = Expression.Lambda<Func<object, int?>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }
             else if(entityProperty.PropertyType == typeof(long?)){
                var lambda = Expression.Lambda<Func<object, long?>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }
             else if(entityProperty.PropertyType == typeof(long)){
                var lambda = Expression.Lambda<Func<object, long>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }
             else if(entityProperty.PropertyType == typeof(DateTimeOffset?)){
                var lambda = Expression.Lambda<Func<object, DateTimeOffset?>>(property, entity);
                columns.Add(lambda).Titled(propertyDisplayName);
            }*/       
            else
            {
                //Use reflection to build up lambda expression and call columns.Add(...) and Titled(...) for any field that can be rendered as text.
                //This is equivalent to:
                //if(entityProperty.PropertyType == typeof(Foo?)){
                //  var lambda = Expression.Lambda<Func<object, Foo?>>(property, entity);
                //  columns.Add(lambda).Titled(propertyDisplayName);
                //}
                //But avoids needing an else if for each possible type, nullable types, etc..
               var funcType = typeof(Func<,>).MakeGenericType(typeof(object),entityProperty.PropertyType);              
               var lambdaMethod = typeof(Expression).GetMethods(BindingFlags.Public|BindingFlags.Static).Where(m=>m.Name == "Lambda" && m.IsGenericMethod).First().MakeGenericMethod(funcType);
               var lambda = lambdaMethod.Invoke(null,new object[]{property,new ParameterExpression[]{entity}});
               var addMethod = columns.GetType().GetMethods(BindingFlags.Public|BindingFlags.Instance).Where(m=>m.Name=="Add" && m.IsGenericMethod).First();               
               var column = addMethod.MakeGenericMethod(entityProperty.PropertyType).Invoke(columns,new object[]{lambda});
               var titledMethod = typeof(GridColumnExtensions).GetMethods(BindingFlags.Static|BindingFlags.Public).Where(m=>m.Name=="Titled").First().MakeGenericMethod(typeof(object),entityProperty.PropertyType);
               titledMethod.Invoke(null, new[]{column, propertyDisplayName});          
            }
        }

        // only supports single PKs, not composite ones
        var pkProperties = Model.DbContext.Model.FindEntityTypes(Model.EntityType).First().FindPrimaryKey().Properties;
        if (pkProperties.Count == 1)
        {
            var pKProperty = pkProperties.Single()?.PropertyInfo;

            if (pKProperty != null)
            {
                columns.Add(item => Html.ActionLink(_localizer["Delete"], "DeleteEntity", new { dbSetName = Model.DbSetProperty.Name, Id = pKProperty.GetValue(item)}));
                columns.Add(item => Html.ActionLink(@_localizer["Edit"], "EditEntity", new { dbSetName = Model.DbSetProperty.Name, Id = pKProperty.GetValue(item) }));
            }
        }


    }

        )
    .Using(options.FilterMode)
    .Empty("No data found")
    .Filterable()
    .Sortable()
    .Pageable(pager =>
    {
        pager.PageSizes = options.PageSizes;
        pager.ShowPageSizes = options.ShowPageSizes;
    })
)

@section Scripts
{
     <script>
        document.querySelectorAll(".mvc-grid").forEach(element => new MvcGrid(element));
     </script>
}


